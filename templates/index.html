<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ë¶„ë¥˜ê¸°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #E0F7FA;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            margin-top:30vh;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 70%; /* í™”ë©´ì˜ ì ˆë°˜ ì´ìƒì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            display: flex;
            flex-direction: column;
            text-align: center;
            justify-content: center;
            min-height: 100vh;
        }
        .container h1 {
            color: #007BFF;
            /* margin-bottom: 20px; */
            font-size: 2em;
        }
        p {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 30px;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #0288D1;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #01579B;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px;
        }
        .grid img {
            width: 300px; /* ì´ë¯¸ì§€ í¬ê¸° ì¤„ì„ */
            height: 200px; /* ì´ë¯¸ì§€ ë†’ì´ ì¶”ê°€ */
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 5px;
            transition: border 0.3s;
            position: relative;
        }
        .grid img.selected {
            border: 5px solid blue; /* ì„ íƒëœ ì´ë¯¸ì§€ í…Œë‘ë¦¬ */
        }
        .grid label {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: white;
            padding: 2px;
            border-radius: 50%;
            font-size: 12px;
        }
        input[type="checkbox"] {
            display: none;
        }
        .selected + label::after {
            content: "âœ”"; /* ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ ì²´í¬ í‘œì‹œ */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš§ì‹œìŠ¤í…œ ë¹„ì •ìƒì  ì ‘ê·¼(í•´í‚¹) íƒì§€ ê¸°ëŠ¥</h1>
        <p id="instruction">ê°•ì•„ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="grid" id="imageGrid"></div>
        <button id="submitBtn">OK</button>
        <h2 id="result"></h2>
    </div>

    <script>
        
        let expectedLabel = "dog"; // ì‚¬ìš©ìê°€ ì„ íƒí•´ì•¼ í•  ë ˆì´ë¸”
        let selectedImages = [];
        let dogCount = 0;

        // ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ ìƒì„±
        async function createGrid() {
            const response = await fetch('/images');
            let images = await response.json();
            images = images.slice(0, 9); // ìµœëŒ€ 9ê°œì˜ ì´ë¯¸ì§€ë¡œ ì œí•œ

            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            images.forEach(image => {
                const div = document.createElement('div');
                div.style.position = 'relative';
                
                const imgElement = document.createElement('img');
                imgElement.src = image.src;
                imgElement.dataset.label = image.label;
                imgElement.onclick = () => handleImageClick(imgElement);

                if (image.label === 'dog') {
                    dogCount++; // ê°•ì•„ì§€ ì´ë¯¸ì§€ë¥¼ ì°¾ìœ¼ë©´ ê°œìˆ˜ë¥¼ ì¦ê°€ì‹œí‚´
                }
                
                const checkBox = document.createElement('input');
                checkBox.type = 'checkbox';
                checkBox.className = 'imgCheckbox';
                
                const label = document.createElement('label');
                label.textContent = "";

                div.appendChild(imgElement);
                div.appendChild(checkBox);
                div.appendChild(label);
                
                grid.appendChild(div);
            });
        }

        // ì´ë¯¸ì§€ í´ë¦­ ì²˜ë¦¬
        async function handleImageClick(imgElement) {
            const fileResponse = await fetch(imgElement.src);
            const blob = await fileResponse.blob();
            const formData = new FormData();
            formData.append('file', blob, 'image.jpg');

            const predictionResponse = await fetch('/predict', {
                method: 'POST',
                body: formData
            });
            const prediction = await predictionResponse.json();

            console.log("ì˜ˆì¸¡ ë ˆì´ë¸”: ", prediction.prediction); // ì˜ˆì¸¡ê°’ ì¶œë ¥
            console.log("ì´ë¯¸ì§€ ë ˆì´ë¸”: ", imgElement.dataset.label); // ì„ íƒëœ ì´ë¯¸ì§€ì˜ ë ˆì´ë¸” ì¶œë ¥

            // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì´ë¯¸ì§€ê°€ ì–´ë–¤ ë ˆì´ë¸”ì¸ì§€ í™•ì¸
            if (!expectedLabel) {
                expectedLabel = prediction.prediction; // ì²« ë²ˆì§¸ í´ë¦­í•œ ì´ë¯¸ì§€ì˜ ë ˆì´ë¸” ì„¤ì •
                console.log("expectedLabel ì„¤ì •ë¨: ", expectedLabel); // ì„¤ì •ëœ expectedLabel ì¶œë ¥
            }

            imgElement.classList.toggle('selected');
            const checkBox = imgElement.nextSibling; // ì²´í¬ë°•ìŠ¤ ì„ íƒ
            checkBox.checked = !checkBox.checked;

            if (selectedImages.includes(imgElement)) {
                selectedImages = selectedImages.filter(img => img !== imgElement); // ì¤‘ë³µ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
            } else {
                selectedImages.push(imgElement); // ì„ íƒ ì´ë¯¸ì§€ ì¶”ê°€
            }
        }

        // ì œì¶œ ë²„íŠ¼ í´ë¦­ ì‹œ ê²€ì¦
        document.getElementById('submitBtn').onclick = () => {
            const resultElement = document.getElementById('result');

            // ì‚¬ìš©ìê°€ ì„ íƒí•œ ê°•ì•„ì§€ ì´ë¯¸ì§€ ìˆ˜
            const selectedDogCount = selectedImages.filter(img => img.dataset.label === 'dog').length;

            const hasCat = selectedImages.some(img => img.dataset.label === 'cat');


            if (hasCat) {
                resultElement.innerText = `ì‹¤íŒ¨! ì„ íƒí•œ ì´ë¯¸ì§€ì— ê³ ì–‘ì´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
                alert("ì‹¤íŒ¨");
            } else if (selectedDogCount !== dogCount) {
                resultElement.innerText = `ì‹¤íŒ¨! ê°•ì•„ì§€ ì´ë¯¸ì§€ê°€ ${dogCount}ê°œ ìˆëŠ”ë°, ${selectedDogCount}ê°œë§Œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`;
                alert("ë” ì°¾ì•„ì•¼ í•¨.");
            } else if (selectedImages.length > 0 && selectedImages.every(img => img.dataset.label === expectedLabel)) {
                resultElement.innerText = `ì„±ê³µ! ${dogCount}ê°œì˜ ê°•ì•„ì§€ë¥¼ ëª¨ë‘ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`;
                alert("ì„±ê³µ");
                setTimeout(() => {
                    window.location.href = "/home";
                }, 2000); // 2ì´ˆ í›„ì— ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡)
            } else {
                resultElement.innerText = `ì‹¤íŒ¨! ${expectedLabel === 'dog' ? 'ê³ ì–‘ì´' : 'ê°•ì•„ì§€'}ë¥¼ í´ë¦­í–ˆê±°ë‚˜ ì¡°ê±´ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
            }
        };
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë¦¬ë“œ ìƒì„±
        createGrid();
    </script>
</body>
</html>